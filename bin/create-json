#!/usr/bin/env zsh

dbexec() {
  sqlite3 ./us-counties.sqlite3 "$1" "$2"
}

states() {
  dbexec 'select distinct(state) from days'
}

counties() {
  dbexec "select distinct(county) from days where state = '$1'"
}

data_for_county() {
  dbexec -csv "select date,cases,deaths from days where county = \"$1\" AND state = '$2' order by date asc"
}

states | while read state; do
  counties "$state" | while read county; do
    statedir="./json/${state//[[:space:]]/_}"
    test -d "$statedir" || mkdir -vp "$statedir"
    jsonfile="$statedir/${county//[[:space:]]/_}.json"
    test -e "$jsonfile" && rm -v "$jsonfile"
    (echo "date,cases,deaths"; data_for_county "$county" "$state") | csvjson > "$jsonfile"
  done
done
